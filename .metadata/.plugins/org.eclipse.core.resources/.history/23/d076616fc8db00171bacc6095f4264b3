package com.cioclass.service.or.impl;

import java.util.List;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.cioclass.dao.or.QrcodeBuilder4XSDao;
import com.cioclass.domain.or.QrcodeBuilder4XSEntity;
import com.cioclass.service.or.QrcodeBuilder4XSService;
import com.cioclass.util.DateUtils;
import com.cioclass.util.or.xs.QrcodeBuilder4XS2DB;
import com.google.common.collect.Lists;

@Service
public class QrcodeBuilder4XSServiceImpl implements QrcodeBuilder4XSService {
	private static final Logger LOG = LoggerFactory.getLogger(QrcodeBuilder4XSServiceImpl.class);
	@Autowired
	private QrcodeBuilder4XSDao qrcodeBuilder4XSDao;

	@Override
	public QrcodeBuilder4XSEntity save(QrcodeBuilder4XSEntity qbe) {
		return qrcodeBuilder4XSDao.save(qbe);
	}

	@Override
	public List<QrcodeBuilder4XSEntity> save(List<QrcodeBuilder4XSEntity> list) {
		return qrcodeBuilder4XSDao.save(list);
	}

	@Override
	public List<QrcodeBuilder4XSEntity> createContent(String en, String bn, String url, int size, int num) {
		Set<String> set = getSet(size, num);
		List<QrcodeBuilder4XSEntity> list = Lists.newArrayList();
		List<QrcodeBuilder4XSEntity> result = Lists.newArrayList();
		int i = 1;
		int temp = 0;
		QrcodeBuilder4XSEntity qbe = null;
		for (String s : set) {
			qbe = new QrcodeBuilder4XSEntity();
			qbe.setBn(bn);
			qbe.setEn(en);
			qbe.setUrl(url);
			qbe.setCode(s);
			qbe.setCodeSize(size);
			String numStr = getNumStr(i, 6);
			qbe.setNum(numStr);
			qbe.setNumSize(numStr.length());
			qbe.setPrefix("?o=");
			qbe.setCreateTime(DateUtils.getNow());
			if (list.add(qbe)) {
				temp++;
			} else {
				LOG.error("数据处理发生报错！");
				return null;
			}
			if (temp == 100) {
				if (!result.addAll(qrcodeBuilder4XSDao.save(list))) {
					LOG.error("数据处理发生报错(DB)！");
					return null;
				}
				list = Lists.newArrayList();
				temp = 0;
			}
			i++;
		}
		// 处理结尾的数据
		if (temp != 0) {
			if (!result.addAll(qrcodeBuilder4XSDao.save(list))) {
				LOG.error("数据处理发生报错(DB-end)！");
				return null;
			}
		}
		return result;
	}

}
